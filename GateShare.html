<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>UnterGrund Gate teilen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #f5f5f5;
      background: radial-gradient(circle at top, #4c1d95 0, #020617 55%, #000 100%);
      display: flex;
      justify-content: center;
      padding: 32px 12px;
      font-size: 16px;
    }

    .gate-wrap {
      position: relative;
      min-height: calc(var(--vh, 1vh) * 100);
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
    }

    .card-shell {
      position: relative;
      width: 100%;
      max-width: 420px;
      height: 900px;
      border-radius: 22px;
      padding: 3px;
      background:
        radial-gradient(circle at -10% -20%, rgba(56,189,248,0.32), transparent 55%),
        radial-gradient(circle at 110% 120%, rgba(168,85,247,0.4), transparent 55%),
        radial-gradient(circle at 50% 0%, rgba(15,23,42,0.9), rgba(2,6,23,1));
      box-shadow:
        0 32px 90px rgba(0,0,0,0.95),
        0 0 40px rgba(129,140,248,0.55);
      box-sizing: border-box;
      transform-origin: center center;
    }

    .card {
      position: relative;
      width: 100%;
      height: 100%;
      border-radius: 18px;
      padding: 14px 14px 11px;
      background: radial-gradient(circle at top left,
                  rgba(15,23,42,0.96) 0,
                  rgba(15,23,42,0.98) 40%,
                  rgba(2,6,23,1) 100%);
      display: flex;
      flex-direction: column;
      color: #e5e7eb;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      overflow: hidden;
      font-size: 14px;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -30%;
      background: conic-gradient(
        from 220deg,
        rgba(168,85,247,0.25),
        transparent 25%,
        rgba(56,189,248,0.2),
        transparent 55%,
        rgba(236,72,153,0.23),
        transparent 80%,
        rgba(129,140,248,0.2)
      );
      mix-blend-mode: screen;
      opacity: 0.6;
      pointer-events: none;
    }

    .card-header {
      position: relative;
      z-index: 1;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
      gap: 8px;
    }

    .card-title-block {
      max-width: 70%;
    }

    .card-label {
      font-size: 11px;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: #a5b4fc;
    }

    .card-name {
      font-size: 18px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      margin-top: 4px;
      color: #f9fafb;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .card-subline {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }

    .back-btn {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.75);
      background: radial-gradient(circle at top, #020617 0, #020617 60%, #020617 100%);
      color: #e5e7eb;
      padding: 7px 12px;
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      cursor: pointer;
      white-space: nowrap;
    }

    .card-photo {
      position: relative;
      z-index: 1;
      flex: 0 0 52%;
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid rgba(55,65,81,0.9);
      background: radial-gradient(circle,#020617 0,#020617 60%,#000 100%);
      margin-bottom: 12px;
      box-shadow: 0 0 24px rgba(15,23,42,0.9);
    }

    .card-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .card-body {
      position: relative;
      z-index: 1;
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 13px;
    }

    .card-section-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: #c4b5fd;
      margin-bottom: 2px;
    }

    .card-text {
      font-size: 13px;
      line-height: 1.5;
      color: #e5e7eb;
    }

    .card-vibes {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 4px;
    }

    .vibe-pill {
      display: inline-block;
      padding: 3px 8px;
      background: rgba(129,140,248,0.15);
      border: 1px solid rgba(129,140,248,0.4);
      border-radius: 999px;
      font-size: 11px;
      color: #c7d2fe;
    }

    .card-city {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
    }

    .collect-section {
      position: relative;
      z-index: 1;
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .collect-btn,
    .share-btn {
      border-radius: 999px;
      border: 1px solid rgba(129,140,248,0.9);
      background: linear-gradient(90deg, #4f46e5, #7c3aed);
      color: #e5e7eb;
      padding: 9px 14px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.09em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .share-btn {
      border-color: rgba(148,163,184,0.8);
      background: linear-gradient(90deg, #0f172a, #1f2937);
      color: #e5e7eb;
      font-weight: 500;
    }

    .collect-btn:hover:not(:disabled),
    .share-btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 0 18px rgba(129,140,248,0.6);
    }

    .collect-btn:disabled,
    .share-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: rgba(31,41,55,0.7);
      border-color: rgba(148,163,184,0.6);
      color: #9ca3af;
      box-shadow: none;
    }

    .collect-info {
      font-size: 11px;
      color: #9ca3af;
      text-align: center;
      min-height: 1em;
    }

    .card-footer {
      position: relative;
      z-index: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      padding-top: 6px;
      border-top: 1px dashed rgba(55,65,81,0.9);
      font-size: 11px;
    }

    .card-footer-left {
      max-width: 65%;
      color: #fca5a5;
      min-height: 1.2em;
    }

    .card-footer-right {
      text-align: right;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      color: #9ca3af;
    }

    .card-number {
      font-size: 11px;
    }

    .card-set {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #a5b4fc;
    }

    .status {
      text-align: center;
      font-size: 13px;
      margin-top: 8px;
      color: #fca5a5;
    }
  </style>
</head>
<body>
  <div class="gate-wrap">
    <div class="card-shell" id="cardShell">
      <div class="card" id="cardContent" style="display:none;">
        <div class="card-header">
          <div class="card-title-block">
            <div class="card-label">UnterGrund Secret Gate</div>
            <div id="gateName" class="card-name">Gate-Name</div>
            <div class="card-subline">Ein geheimer Eintritt in den UnterGrund â€“ sammelbar, solange du den Link hast.</div>
          </div>
          <button id="backButton" class="back-btn">Mein Album</button>
        </div>

        <div class="card-photo">
          <img id="gateImage" src="" alt="Gate Bild">
        </div>

        <div class="card-body">
          <div>
            <div class="card-section-label">Kurzbeschreibung</div>
            <div id="gateDescription" class="card-text"></div>
          </div>

          <div>
            <div class="card-section-label">Vibes</div>
            <div id="gateVibes" class="card-vibes"></div>
          </div>

          <div id="gateCityRow">
            <div class="card-section-label">Herkunft</div>
            <div id="gateCity" class="card-city"></div>
          </div>
        </div>

        <div class="collect-section">
          <button id="collectButton" class="collect-btn">Gate-Karte sammeln</button>
          <button id="shareButton" class="share-btn">Gate-Link teilen</button>
          <div id="collectInfo" class="collect-info"></div>
        </div>

        <div class="card-footer">
          <div id="statusText" class="card-footer-left"></div>
          <div class="card-footer-right">
            <div id="cardNumber" class="card-number">UGâ€‘GATE #0000</div>
            <div class="card-set">Set: Secret Gates Â· S1</div>
          </div>
        </div>
      </div>

      <div id="errorBox" class="status" style="display:none;"></div>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://tyflhzwrwzfakwedipig.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_OkJhaPak_fd0nNg1vxRLPQ_gOiaI6Tb";
    const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const BASE_URL = "https://baurybot-hub.github.io/untergrund/";

    const cardShell = document.getElementById('cardShell');
    const cardContent = document.getElementById('cardContent');
    const errorBox = document.getElementById('errorBox');

    const gateNameEl = document.getElementById('gateName');
    const gateDescriptionEl = document.getElementById('gateDescription');
    const gateVibesEl = document.getElementById('gateVibes');
    const gateCityEl = document.getElementById('gateCity');
    const gateCityRow = document.getElementById('gateCityRow');
    const gateImageEl = document.getElementById('gateImage');

    const collectButton = document.getElementById('collectButton');
    const shareButton = document.getElementById('shareButton');
    const collectInfo = document.getElementById('collectInfo');
    const statusText = document.getElementById('statusText');
    const cardNumberEl = document.getElementById('cardNumber');
    const backButton = document.getElementById('backButton');

    let currentGateId = null;
    let currentShareSlug = null;

    function updateViewportScale() {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);

      const outerPadding = 4 * 2;
      const availableHeight = window.innerHeight - outerPadding;
      const baseHeight = 900;
      const scale = Math.min(1, availableHeight / baseHeight);

      cardShell.style.transformOrigin = 'center center';
      cardShell.style.transform = `scale(${scale})`;
    }

    window.addEventListener('resize', updateViewportScale);
    window.addEventListener('orientationchange', updateViewportScale);

    function setError(msg) {
      errorBox.style.display = 'block';
      errorBox.textContent = msg;
      cardContent.style.display = 'none';
    }

    // NEU: Nummer aus Slug ableiten
    function setCardNumberFromSlug(slug) {
      if (!slug) {
        cardNumberEl.textContent = "UGâ€‘GATE #0000";
        return;
      }
      const codePart = slug.slice(-4).toUpperCase();
      const displayCode = codePart && codePart.length === 4 ? codePart : "0000";
      cardNumberEl.textContent = "UGâ€‘GATE #" + displayCode;
    }

    function renderVibes(m1, m2, m3) {
      gateVibesEl.innerHTML = "";
      const vibes = [m1, m2, m3].map(v => (v || "").trim()).filter(Boolean);
      if (vibes.length === 0) {
        const span = document.createElement("span");
        span.className = "vibe-pill";
        span.textContent = "no vibes yet";
        gateVibesEl.appendChild(span);
        return;
      }
      vibes.forEach(v => {
        const pill = document.createElement("span");
        pill.className = "vibe-pill";
        pill.textContent = v;
        gateVibesEl.appendChild(pill);
      });
    }

    async function checkGateAlreadyCollected(gateCardId) {
      const { data: sessionData } = await supa.auth.getSession();
      if (!sessionData || !sessionData.session) return false;

      const userId = sessionData.session.user.id;

      const { data, error } = await supa
        .from('gate_collection')
        .select('id')
        .eq('user_id', userId)
        .eq('gate_card_id', gateCardId)
        .limit(1);

      if (error) {
        console.error(error);
        return false;
      }

      return data && data.length > 0;
    }

    async function handleCollectClick() {
      const { data: sessionData, error: sessionError } = await supa.auth.getSession();

      if (sessionError || !sessionData || !sessionData.session) {
        collectInfo.textContent = 'Melde dich an, um Gate-Karten zu sammeln.';
        return;
      }

      const userId = sessionData.session.user.id;
      collectButton.disabled = true;
      collectInfo.textContent = 'FÃ¼ge Gate-Karte zu deinem Gate-Album hinzu ...';

      const { error } = await supa
        .from('gate_collection')
        .insert({
          user_id: userId,
          gate_card_id: currentGateId
        });

      if (error) {
        if (error.code === '23505') {
          collectInfo.textContent = 'Diese Gate-Karte ist bereits in deinem Gate-Album.';
          collectButton.textContent = 'Bereits gesammelt';
          collectButton.disabled = false;
          return;
        }
        console.error(error);
        collectInfo.textContent = 'Fehler beim Sammeln. Versuch es spÃ¤ter nochmal.';
        collectButton.disabled = false;
        return;
      }

      collectButton.textContent = 'âœ“ Gesammelt';
      collectInfo.textContent = 'Gate-Karte zu deinem Gate-Album hinzugefÃ¼gt.';
      statusText.textContent = 'Dieses Gate ist jetzt Teil deiner Sammlung.';
    }

    async function initShareButton() {
      if (!currentShareSlug) {
        shareButton.disabled = true;
        return;
      }
      const shareUrl = `${BASE_URL}GateShare.html?s=${encodeURIComponent(currentShareSlug)}`;

      shareButton.onclick = async () => {
        if (navigator.share) {
          try {
            await navigator.share({
              title: gateNameEl.textContent || 'UnterGrund Gate',
              text: 'Schau dir dieses Gate an und sammle es in deinem Gate-Album.',
              url: shareUrl
            });
            collectInfo.textContent = 'Gate-Link wurde geteilt.';
          } catch (e) {
            console.error(e);
          }
        } else if (navigator.clipboard) {
          try {
            await navigator.clipboard.writeText(shareUrl);
            collectInfo.textContent = 'Gate-Link in die Zwischenablage kopiert.';
          } catch (e) {
            console.error(e);
            collectInfo.textContent = 'Konnte Link nicht kopieren.';
          }
        } else {
          collectInfo.textContent = shareUrl;
        }
      };
    }

    async function loadGateFromSlug() {
      const params = new URLSearchParams(window.location.search);
      const slug = params.get('s');

      if (!slug) {
        setError('Kein Gate-Slug in der URL gefunden.');
        return;
      }

      currentShareSlug = slug;

      const { data, error } = await supa
        .from('gate_cards')
        .select('id, image_path, name, description, mood1, mood2, mood3, city, share_slug')
        .eq('share_slug', slug)
        .maybeSingle();

      if (error || !data) {
        console.error(error);
        setError('Dieses Gate gibt es nicht (mehr).');
        return;
      }

      currentGateId = data.id;

      gateNameEl.textContent = data.name || 'Unbenanntes Gate';
      gateDescriptionEl.textContent = data.description || 'Noch keine Beschreibung hinterlegt.';
      renderVibes(data.mood1, data.mood2, data.mood3);

      if (data.city) {
        gateCityEl.textContent = `ðŸ“ ${data.city}`;
        gateCityRow.style.display = 'block';
      } else {
        gateCityRow.style.display = 'none';
      }

      if (data.image_path) {
        gateImageEl.src = data.image_path;
      }

      // Nummer aus share_slug ziehen
      setCardNumberFromSlug(data.share_slug);

      cardContent.style.display = 'flex';
      errorBox.style.display = 'none';

      const alreadyCollected = await checkGateAlreadyCollected(currentGateId);
      if (alreadyCollected) {
        collectButton.textContent = 'Bereits gesammelt';
        collectInfo.textContent = 'Diese Gate-Karte ist bereits in deinem Gate-Album.';
      }

      collectButton.onclick = handleCollectClick;
      await initShareButton();
      updateViewportScale();
    }

    backButton.onclick = () => {
      window.location.href = `${BASE_URL}MeineSammlung.html`;
    };

    loadGateFromSlug();
  </script>
</body>
</html>
