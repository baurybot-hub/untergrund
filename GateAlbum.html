<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Gate-Album DEBUG</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: #020617;
      font-family: system-ui, sans-serif;
      color: #f5f5f5;
      padding: 20px;
    }
    .gate-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    .gate-slot {
      background: #111827;
      border-radius: 12px;
      border: 1px solid #4b5563;
      overflow: hidden;
      padding: 8px;
      font-size: 13px;
    }
    .gate-slot img {
      width: 100%;
      height: 140px;
      object-fit: cover;
      display: block;
      border-radius: 8px;
      margin-bottom: 6px;
      background:#020617;
    }
    .log {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      white-space: pre-wrap;
      background:#020617;
      border:1px solid #4b5563;
      border-radius:8px;
      padding:8px;
      margin-top:12px;
      max-height:200px;
      overflow:auto;
    }
  </style>
</head>
<body>
  <h1>Gate-Album DEBUG</h1>
  <div id="info">Lade...</div>
  <div id="gateGrid" class="gate-grid"></div>
  <div id="log" class="log"></div>

  <script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
  <script>
    const SUPABASE_URL = "https://tyflhzwrwzfakwedipig.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_OkJhaPak_fd0nNg1vxRLPQ_gOiaI6Tb";
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const infoEl = document.getElementById('info');
    const gridEl = document.getElementById('gateGrid');
    const logEl = document.getElementById('log');

    function log(msg, obj) {
      logEl.textContent += msg + (obj ? ' ' + JSON.stringify(obj, null, 2) : '') + "\n";
    }

    async function loadDebugAlbum() {
      log('loadDebugAlbum start');

      const {  sessionData, error: sessionError } = await client.auth.getSession();
      log('getSession result:', { sessionData, sessionError });

      if (sessionError || !sessionData || !sessionData.session) {
        infoEl.textContent = 'KEINE SESSION (du bist f체r Supabase hier nicht eingeloggt).';
        return;
      }

      const user = sessionData.session.user;
      infoEl.textContent = 'Eingeloggt als: ' + (user.email || user.id);

      const {  collections, error: collError } = await client
        .from('gate_collection')
        .select('gate_card_id, collected_at')
        .eq('user_id', user.id)
        .order('collected_at', { ascending: true });

      log('gate_collection:', { collections, collError });

      if (collError) {
        infoEl.textContent = 'Fehler gate_collection (siehe Log).';
        return;
      }

      if (!collections || collections.length === 0) {
        infoEl.textContent = 'Keine gate_collection-Eintr채ge f체r diesen User gefunden.';
        return;
      }

      const gateIds = collections.map(c => c.gate_card_id);
      log('gateIds:', gateIds);

      const {  gates, error: gatesError } = await client
        .from('gate_cards')
        .select('id, name, image_path')
        .in('id', gateIds);

      log('gate_cards:', { gates, gatesError });

      if (gatesError) {
        infoEl.textContent = 'Fehler gate_cards (siehe Log).';
        return;
      }

      const gateMap = new Map();
      (gates || []).forEach(g => gateMap.set(g.id, g));

      gridEl.innerHTML = '';
      collections.forEach(item => {
        const gate = gateMap.get(item.gate_card_id);
        const slot = document.createElement('div');
        slot.className = 'gate-slot';

        const img = document.createElement('img');
        img.src = gate?.image_path || 'https://via.placeholder.com/300x400?text=Gate';
        img.alt = gate?.name || 'Gate';

        const name = document.createElement('div');
        name.textContent = 'Name: ' + (gate?.name || 'Unbenanntes Gate');

        const meta = document.createElement('div');
        meta.textContent = 'ID: ' + item.gate_card_id + ' | gesammelt: ' + (item.collected_at || '??');

        slot.appendChild(img);
        slot.appendChild(name);
        slot.appendChild(meta);
        gridEl.appendChild(slot);
      });

      infoEl.textContent = 'Fertig geladen. Eintr채ge im Grid: ' + gridEl.children.length;
    }

    loadDebugAlbum();
  </script>
</body>
</html>
